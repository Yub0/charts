name: Release Charts

concurrency: release-helm

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_SKIP_EXISTING: true
          CR_PAGES_BRANCH: gh-pages

      - name: Generate Repository Landing Page
        run: |
          # Fetch updated index.yaml from gh-pages branch
          git fetch origin gh-pages
          git checkout gh-pages
          
          # Create modern HTML from index.yaml using python (built-in in runner)
          python3 - <<EOF
          import yaml
          import datetime

          with open('index.yaml', 'r') as f:
              index = yaml.safe_load(f)

          html_template = """<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Yub0 Helm Charts</title>
              <style>
                  :root {{ --primary: #24292e; --accent: #0366d6; --bg: #f6f8fa; }}
                  body {{ font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif; line-height: 1.5; color: var(--primary); max-width: 900px; margin: 0 auto; padding: 2rem; background: #fff; }}
                  header {{ border-bottom: 1px solid #e1e4e8; padding-bottom: 1rem; margin-bottom: 2rem; }}
                  h1 {{ margin: 0; font-size: 2rem; }}
                  .setup {{ background: var(--bg); padding: 1.5rem; border-radius: 6px; border: 1px solid #e1e4e8; margin-bottom: 2rem; }}
                  code {{ background: #ebf0f4; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: "SFMono-Regular",Consolas,"Liberation Mono",Menlo,monospace; }}
                  pre {{ background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow: auto; border: 1px solid #e1e4e8; }}
                  .chart-card {{ border: 1px solid #e1e4e8; border-radius: 6px; padding: 1.5rem; margin-bottom: 1rem; transition: transform 0.1s; }}
                  .chart-card:hover {{ border-color: var(--accent); }}
                  .chart-header {{ display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }}
                  .chart-icon {{ width: 32px; height: 32px; object-fit: contain; }}
                  .version {{ color: #586069; font-size: 0.9rem; }}
                  .footer {{ margin-top: 4rem; text-align: center; color: #6a737d; font-size: 0.8rem; border-top: 1px solid #eee; padding-top: 2rem; }}
              </style>
          </head>
          <body>
              <header>
                  <h1>ðŸ“¦ Yub0 Helm Charts Repository</h1>
              </header>
              
              <section class="setup">
                  <h3>ðŸš€ Quick Setup</h3>
                  <pre><code>helm repo add yub0 https://yub0.github.io/charts/
          helm repo update</code></pre>
              </section>

              <section>
                  <h3>ðŸ“‹ Available Charts</h3>
                  {charts_html}
              </section>

              <footer class="footer">
                  Last updated on {now} | Generated by GitHub Actions
              </footer>
          </body>
          </html>"""

          charts_html = ""
          for name, versions in sorted(index.get('entries', {}).items()):
              latest = versions[0]
              icon = latest.get('icon', 'https://helm.sh/img/helm.svg')
              charts_html += f'''
              <div class="chart-card">
                  <div class="chart-header">
                      <img src="{icon}" class="chart-icon" alt="{name}">
                      <h2 style="margin:0">{name}</h2>
                      <span class="version">v{latest['version']}</span>
                  </div>
                  <p style="margin:0.5rem 0">{latest.get('description', 'No description available.')}</p>
                  <code>helm install my-{name} yub0/{name}</code>
              </div>'''

          with open('index.html', 'w') as f:
              f.write(html_template.format(
                  charts_html=charts_html, 
                  now=datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S UTC")
              ))
          EOF

          # Commit and push index.html
          git add index.html
          git diff --staged --quiet || git commit -m "docs: auto-generate repository landing page"
          git push origin gh-pages
          
          # Return to main
          git checkout main
